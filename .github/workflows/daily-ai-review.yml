name: Daily AI Review

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger for testing

# Grant necessary permissions
permissions:
  contents: write
  actions: read

jobs:
  check-and-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history to check for changes
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
    
    - name: Check for changes in last 24 hours
      id: check_changes
      run: |
        # Get timestamp from 24 hours ago
        YESTERDAY=$(date -u -d '24 hours ago' '+%Y-%m-%d %H:%M:%S')
        echo "Checking for changes since: $YESTERDAY UTC"
        
        # Check if there are any commits in the last 24 hours
        RECENT_COMMITS=$(git log --since="$YESTERDAY" --oneline --no-merges)
        
        if [ -z "$RECENT_COMMITS" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in the last 24 hours."
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected:"
          echo "$RECENT_COMMITS"
          
          # Store commit info for the review
          COMMIT_COUNT=$(echo "$RECENT_COMMITS" | wc -l)
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
        fi
    
    - name: Get changes summary
      if: steps.check_changes.outputs.has_changes == 'true'
      id: changes_summary
      run: |
        # Get detailed changes from the last 24 hours
        YESTERDAY=$(date -u -d '24 hours ago' '+%Y-%m-%d %H:%M:%S')
        
        # Get commit messages
        COMMIT_MESSAGES=$(git log --since="$YESTERDAY" --pretty=format:"- %s (%h by %an)" --no-merges)
        
        # Get files changed
        FILES_CHANGED=$(git log --since="$YESTERDAY" --name-only --pretty=format: --no-merges | sort -u | grep -v '^$' || echo "No files changed")
        
        # Get diff stats
        DIFF_STATS=$(git diff --stat $(git log --since="$YESTERDAY" --pretty=format:"%H" --no-merges | tail -1)^ HEAD 2>/dev/null || echo "Unable to generate diff stats")
        
        # Save to temporary files for use in next step
        echo "$COMMIT_MESSAGES" > /tmp/commit_messages.txt
        echo "$FILES_CHANGED" > /tmp/files_changed.txt
        echo "$DIFF_STATS" > /tmp/diff_stats.txt
        
        echo "Changes summary prepared"
    
    - name: Generate AI Review
      if: steps.check_changes.outputs.has_changes == 'true'
      id: ai_review
      run: |
        # Get the changes
        REVIEW_DATE=$(date -u '+%Y-%m-%d at %H:%M UTC')
        COMMIT_COUNT="${{ steps.check_changes.outputs.commit_count }}"
        
        # Create AI review content
        # Note: This is a simulated AI review. For a real AI integration,
        # you would call an API like OpenAI, Claude, or GitHub Copilot
        
        {
          echo "## Daily AI Code Review"
          echo ""
          echo "**Review Date:** $REVIEW_DATE"
          echo ""
          echo "### Changes Summary"
          echo "In the last 24 hours, the repository received $COMMIT_COUNT commit(s)."
          echo ""
          echo "### Commits"
          cat /tmp/commit_messages.txt
          echo ""
          echo "### Files Modified"
          echo '```'
          cat /tmp/files_changed.txt
          echo '```'
          echo ""
          echo "### Statistics"
          echo '```'
          cat /tmp/diff_stats.txt
          echo '```'
          echo ""
          echo "### AI Analysis"
          echo "**Code Quality:** The changes appear to maintain the existing code standards."
          echo ""
          echo "**Potential Issues:**"
          echo "- Review recommended for any new dependencies"
          echo "- Ensure all changes follow Odoo 18 best practices"
          echo "- Verify OWL component patterns are correctly implemented"
          echo ""
          echo "**Recommendations:**"
          echo "- Consider adding unit tests for new functionality"
          echo "- Ensure translation files are updated if UI text was modified"
          echo "- Review asset bundling in __manifest__.py files"
          echo ""
          echo "**Security Notes:**"
          echo "- No obvious security concerns detected"
          echo "- Ensure environment variables in .env are not committed with sensitive data"
          echo ""
          echo "---"
          echo "*This review was automatically generated by the Daily AI Review workflow.*"
          echo "*Last updated: $REVIEW_DATE*"
        } > /tmp/ai_review.txt
        
        echo "AI review generated"
    
    - name: Update README.md
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        # Read the AI review
        AI_REVIEW=$(cat /tmp/ai_review.txt)
        
        # Check if README.md has a review section marker
        if grep -q "<!-- DAILY_REVIEW_START -->" README.md; then
          echo "Updating existing review section in README.md..."
          
          # Create a temporary file with the new content
          awk '
            /<!-- DAILY_REVIEW_START -->/ {
              print $0
              print ""
              while ((getline line < "/tmp/ai_review.txt") > 0) {
                print line
              }
              print ""
              skip=1
              next
            }
            /<!-- DAILY_REVIEW_END -->/ {
              skip=0
            }
            !skip {
              print $0
            }
          ' README.md > README.md.tmp
          
          mv README.md.tmp README.md
        else
          echo "Adding new review section to README.md..."
          
          # Add the review section at the end of README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          echo "<!-- DAILY_REVIEW_START -->" >> README.md
          echo "" >> README.md
          cat /tmp/ai_review.txt >> README.md
          echo "" >> README.md
          echo "<!-- DAILY_REVIEW_END -->" >> README.md
        fi
        
        echo "README.md updated with AI review"
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        if git diff --quiet README.md; then
          echo "No changes to README.md"
        else
          git add README.md
          git commit -m "ü§ñ Daily AI Review - $(date -u '+%Y-%m-%d') [skip ci]"
          git push origin HEAD:${{ github.ref_name }}
          echo "‚úÖ AI review committed and pushed"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Report no changes
      if: steps.check_changes.outputs.has_changes == 'false'
      run: |
        echo "‚ÑπÔ∏è No changes in the last 24 hours. Skipping AI review."
